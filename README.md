ECSTaskAnalyzer Lambda Function Overview This AWS Lambda function analyzes recently stopped ECS tasks for a specified ECS service. fetches ECS stopped tasks information, and identifies if tasks stopped due to maintenance or scaling. If a stopped task's reason is unexpected, it can trigger an alert (e.g., PagerDuty). 1. Imports and Package Setup We import packages needed for JSON handling, HTTP requests, AWS Lambda, AWS SDK for ECS and Secrets Manager, context handling, etc. The package is main as this is a standalone executable (AWS Lambda). 2. Global Variable Environment is a string variable that will hold the environment name (like prod, devcd) 3. Data Structures - TaskResult: Struct to hold info about each ECS task stopped - SplunkBody: Struct representing the inner event body sent by Splunk with fields like Severity, Detector, ServiceName, etc. 4. Helper Functions - isMaintenance(reason string) bool: Returns true if the stop reason contains the word indicating maintenance - isScaling(reason string) bool: Returns true if the stop reason contains the word indicating scaling 5. sendPagerDutyAlert Function This sends an alert to PagerDuty if a task stopped for an unexpected reason. It creates a JSON payload containing details like severity, detector, task ARN, etc. Sends HTTP POST request to PagerDuty’s events API. Checks the response — expects HTTP 202 Accepted, else returns an error. 6. getSecret Function Uses AWS Secrets Manager API to fetch a secret. It retrieves a secret by name, parses the JSON secret string, and extracts the PagerDuty routing key. Returns the key or an error if something fails. 7. handler Function — The Lambda Handler - Input: Takes a JSON event, AWS ECS client, and PagerDuty secret key. Parses the outer event JSON to get the inner event Body string. Parses the inner Body string (expected to be a Splunk event) into SplunkBody struct. Prints details from the Splunk event for logging. Validates that the ServiceName field is not empty; if empty, returns error. Creates a timeout context of 10 seconds to enforce Lambda handler time limits. Calls ECS ListTasks API (ListTasks) to get stopped tasks for the given service in the specified ECS cluster (Environment). If no stopped tasks found, logs this and returns an empty list immediately. Calls ECS DescribeTasks API (DescribeTasks) to get detailed info about the stopped tasks. - For each stopped task: Checks if context is cancelled (timeout). Extracts task ARN and stop reason. Checks if stop reason is due to maintenance or scaling. Appends task info to results list. If stop reason is NOT maintenance or scaling, triggers PagerDuty alert by calling sendPagerDutyAlert() Returns the list of TaskResult structs to AWS Lambda runtime. 8. main Function Loads AWS SDK default config. Creates clients for AWS Secrets Manager and ECS. Reads the environment name from environment variables. Fetches PagerDuty secret key from Secrets Manager using getSecret. Starts the Lambda function using lambda.Start() and wraps the handler function to pass ECS client and secret value. Summary: What this Lambda does Triggered by an event (likely from Splunk or CloudWatch). Parses the event to extract ECS service name and details. Lists stopped ECS tasks for that service. Describes stopped tasks for detailed reasons. Checks if task stopped due to maintenance/scaling or unexpected reasons. If unexpected, sends alert to PagerDuty. Returns info about stopped tasks.
